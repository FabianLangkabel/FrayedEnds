Bootstrap: docker
From: ubuntu:22.04

%environment
    export DEBIAN_FRONTEND=noninteractive
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export PATH=/opt/conda/bin:$PATH
    export MADNESS_DIR=/usr/local/madness
    export LD_LIBRARY_PATH=/opt/intel/oneapi/mkl/latest/lib:$LD_LIBRARY_PATH
	export CMAKE_BUILD_PARALLEL_LEVEL=2

%post
    apt-get update && apt-get install -y --no-install-recommends \
        sudo \
        wget \
        curl \
        git \
        bzip2 \
        ca-certificates \
        build-essential \
        gfortran \
        cmake \
        openmpi-bin \
        openmpi-common \
        libopenmpi-dev \
        libomp-dev \
        libglib2.0-0 \
        libsm6 \
        libxcomposite1 \
        libxcursor1 \
        libxdamage1 \
        libxext6 \
        libxfixes3 \
        libxi6 \
        libxinerama1 \
        libxrandr2 \
        libxrender1 \
        mercurial \
        procps \
        subversion \
        gnupg && \
        apt-get clean && rm -rf /var/lib/apt/lists/*

	# Miniforge
	wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O miniforge.sh && \
		bash miniforge.sh -b -p /opt/conda && \
		rm miniforge.sh && \
		ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
		echo ". /opt/conda/etc/profile.d/conda.sh" >> /etc/bash.bashrc && \
		echo "conda activate base" >> /etc/bash.bashrc
		
	conda config --add channels conda-forge && \
		conda config --set channel_priority strict

    # Intel MKL
    wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | tee /usr/share/keyrings/oneapi.gpg > /dev/null && \
        echo "deb [signed-by=/usr/share/keyrings/oneapi.gpg] https://apt.repos.intel.com/oneapi all main" > /etc/apt/sources.list.d/oneapi.list && \
        apt-get update && apt-get install -y intel-oneapi-mkl-devel && \
        apt-get clean && rm -rf /var/lib/apt/lists/*

    # Build MADNESS
    cd /opt && \
        git clone https://github.com/m-a-d-n-e-s-s/madness.git && \
        cd madness && \
        sed -i 's/testgconv.cc//' src/madness/mra/CMakeLists.txt && \
        mkdir build && cd build && \
        cmake -DENABLE_MPI=OFF -DENABLE_MKL=ON \
              -DCMAKE_INSTALL_PREFIX=/usr/local/madness \
              -DLAPACK_LIBRARIES=/opt/intel/oneapi/mkl/latest/lib/intel64/libmkl_rt.so \
              -DLAPACK_INCLUDE_DIRS=/opt/intel/oneapi/mkl/latest/include/ \
              -DCMAKE_CXX_FLAGS="-O3 -DNDEBUG" .. && \
        cmake --build . --target install -j2

    # Python + Pakete
    /opt/conda/bin/conda install -y python=3.11 && \
        /opt/conda/bin/pip install pyscf tequila-basic qulacs block2 nanobind && \
        /opt/conda/bin/conda install -c conda-forge nwchem openmpi && \
        /opt/conda/bin/conda install -c kottmann madtequila && \
        /opt/conda/bin/conda install ipykernel --update-deps --force-reinstall

%files
    . /workspaces/frayed-ends

%post
    cd /workspaces/frayed-ends && \
		export CMAKE_BUILD_PARALLEL_LEVEL=2 && \
        /opt/conda/bin/pip install -e .

%runscript
    exec /bin/bash